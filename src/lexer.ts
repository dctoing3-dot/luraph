export enum TokenType{NUMBER='NUMBER',STRING='STRING',BOOLEAN='BOOLEAN',NIL='NIL',IDENTIFIER='IDENTIFIER',AND='AND',BREAK='BREAK',DO='DO',ELSE='ELSE',ELSEIF='ELSEIF',END='END',FALSE='FALSE',FOR='FOR',FUNCTION='FUNCTION',GOTO='GOTO',IF='IF',IN='IN',LOCAL='LOCAL',NOT='NOT',OR='OR',REPEAT='REPEAT',RETURN='RETURN',THEN='THEN',TRUE='TRUE',UNTIL='UNTIL',WHILE='WHILE',CONTINUE='CONTINUE',PLUS='PLUS',MINUS='MINUS',STAR='STAR',SLASH='SLASH',DOUBLE_SLASH='DOUBLE_SLASH',PERCENT='PERCENT',CARET='CARET',HASH='HASH',EQ='EQ',NEQ='NEQ',LT='LT',GT='GT',LTE='LTE',GTE='GTE',ASSIGN='ASSIGN',LPAREN='LPAREN',RPAREN='RPAREN',LBRACE='LBRACE',RBRACE='RBRACE',LBRACKET='LBRACKET',RBRACKET='RBRACKET',SEMICOLON='SEMICOLON',COLON='COLON',DOUBLE_COLON='DOUBLE_COLON',COMMA='COMMA',DOT='DOT',DOT_DOT='DOT_DOT',DOT_DOT_DOT='DOT_DOT_DOT',EOF='EOF'}
export interface Token{type:TokenType;value:string;literal?:any;line:number;column:number}
const KEYWORDS:Record<string,TokenType>={'and':TokenType.AND,'break':TokenType.BREAK,'do':TokenType.DO,'else':TokenType.ELSE,'elseif':TokenType.ELSEIF,'end':TokenType.END,'false':TokenType.FALSE,'for':TokenType.FOR,'function':TokenType.FUNCTION,'goto':TokenType.GOTO,'if':TokenType.IF,'in':TokenType.IN,'local':TokenType.LOCAL,'nil':TokenType.NIL,'not':TokenType.NOT,'or':TokenType.OR,'repeat':TokenType.REPEAT,'return':TokenType.RETURN,'then':TokenType.THEN,'true':TokenType.TRUE,'until':TokenType.UNTIL,'while':TokenType.WHILE,'continue':TokenType.CONTINUE};
export interface DebugLog{phase:string;message:string;data?:any}
let debugLogs:DebugLog[]=[];let debugEnabled=false;
export function enableDebug(enabled:boolean=true):void{debugEnabled=enabled;debugLogs=[];}
export function getDebugLogs():DebugLog[]{return debugLogs;}
function debug(phase:string,message:string,data?:any):void{if(debugEnabled)debugLogs.push({phase,message,data});}
export class Lexer{private source:string;private tokens:Token[]=[];private start=0;private current=0;private line=1;private column=1;private startColumn=1;constructor(source:string){this.source=source;}public tokenize():Token[]{while(!this.isAtEnd()){this.start=this.current;this.startColumn=this.column;this.scanToken();}this.tokens.push({type:TokenType.EOF,value:'',line:this.line,column:this.column});return this.tokens;}private scanToken():void{const c=this.advance();switch(c){case'(':this.addToken(TokenType.LPAREN);break;case')':this.addToken(TokenType.RPAREN);break;case'{':this.addToken(TokenType.LBRACE);break;case'}':this.addToken(TokenType.RBRACE);break;case']':this.addToken(TokenType.RBRACKET);break;case'+':this.addToken(TokenType.PLUS);break;case'*':this.addToken(TokenType.STAR);break;case'%':this.addToken(TokenType.PERCENT);break;case'^':this.addToken(TokenType.CARET);break;case'#':this.addToken(TokenType.HASH);break;case';':this.addToken(TokenType.SEMICOLON);break;case',':this.addToken(TokenType.COMMA);break;case'.':if(this.match('.'))this.addToken(this.match('.')?TokenType.DOT_DOT_DOT:TokenType.DOT_DOT);else if(this.isDigit(this.peek()))this.number();else this.addToken(TokenType.DOT);break;case'-':if(this.match('-'))this.comment();else this.addToken(TokenType.MINUS);break;case'/':this.addToken(this.match('/')?TokenType.DOUBLE_SLASH:TokenType.SLASH);break;case':':this.addToken(this.match(':')?TokenType.DOUBLE_COLON:TokenType.COLON);break;case'[':if(this.peek()==='['||this.peek()==='=')this.longString();else this.addToken(TokenType.LBRACKET);break;case'=':this.addToken(this.match('=')?TokenType.EQ:TokenType.ASSIGN);break;case'~':if(this.match('='))this.addToken(TokenType.NEQ);break;case'<':this.addToken(this.match('=')?TokenType.LTE:TokenType.LT);break;case'>':this.addToken(this.match('=')?TokenType.GTE:TokenType.GT);break;case'"':case"'":this.string(c);break;case' ':case'\r':case'\t':break;case'\n':this.line++;this.column=1;break;default:if(this.isDigit(c))this.number();else if(this.isAlpha(c))this.identifier();break;}}private string(quote:string):void{let value='';while(!this.isAtEnd()&&this.peek()!==quote){if(this.peek()==='\n'){this.line++;this.column=1;}if(this.peek()==='\\'){this.advance();if(!this.isAtEnd()){const esc=this.advance();switch(esc){case'n':value+='\n';break;case't':value+='\t';break;case'r':value+='\r';break;case'\\':value+='\\';break;case'"':value+='"';break;case"'":value+="'";break;case'0':value+='\0';break;case'x':if(this.isHexDigit(this.peek())&&this.isHexDigit(this.peekNext())){value+=String.fromCharCode(parseInt(this.advance()+this.advance(),16));}break;default:if(this.isDigit(esc)){let dec=esc;if(this.isDigit(this.peek()))dec+=this.advance();if(this.isDigit(this.peek()))dec+=this.advance();value+=String.fromCharCode(parseInt(dec,10));}else value+=esc;}}}else value+=this.advance();}if(!this.isAtEnd())this.advance();this.addToken(TokenType.STRING,value);}private longString():void{let level=0;while(this.peek()==='='){this.advance();level++;}if(this.peek()!=='['){this.addToken(TokenType.LBRACKET);return;}this.advance();if(this.peek()==='\n'){this.advance();this.line++;this.column=1;}let value='';const closing=']'+'='.repeat(level)+']';while(!this.isAtEnd()){if(this.peek()==='\n'){value+=this.advance();this.line++;this.column=1;}else if(this.checkSeq(closing)){for(let i=0;i<closing.length;i++)this.advance();break;}else value+=this.advance();}this.addToken(TokenType.STRING,value);}private number():void{if(this.source[this.start]==='0'){const next=this.peek().toLowerCase();if(next==='x'){this.advance();while(this.isHexDigit(this.peek())||this.peek()==='_')this.advance();this.addToken(TokenType.NUMBER,parseInt(this.source.substring(this.start,this.current).replace(/_/g,''),16));return;}else if(next==='b'){this.advance();while(this.peek()==='0'||this.peek()==='1'||this.peek()==='_')this.advance();this.addToken(TokenType.NUMBER,parseInt(this.source.substring(this.start+2,this.current).replace(/_/g,''),2));return;}}while(this.isDigit(this.peek())||this.peek()==='_')this.advance();if(this.peek()==='.'&&this.isDigit(this.peekNext())){this.advance();while(this.isDigit(this.peek())||this.peek()==='_')this.advance();}if(this.peek().toLowerCase()==='e'){this.advance();if(this.peek()==='+'||this.peek()==='-')this.advance();while(this.isDigit(this.peek()))this.advance();}this.addToken(TokenType.NUMBER,parseFloat(this.source.substring(this.start,this.current).replace(/_/g,'')));}private identifier():void{while(this.isAlphaNumeric(this.peek()))this.advance();const text=this.source.substring(this.start,this.current);const kw=KEYWORDS[text];if(kw!==undefined){if(kw===TokenType.TRUE)this.addToken(TokenType.TRUE,true);else if(kw===TokenType.FALSE)this.addToken(TokenType.FALSE,false);else if(kw===TokenType.NIL)this.addToken(TokenType.NIL,null);else this.addToken(kw);}else this.addToken(TokenType.IDENTIFIER,text);}private comment():void{if(this.peek()==='['&&(this.peekNext()==='['||this.peekNext()==='=')){this.advance();let level=0;while(this.peek()==='='){this.advance();level++;}if(this.peek()==='['){this.advance();const closing=']'+'='.repeat(level)+']';while(!this.isAtEnd()){if(this.peek()==='\n'){this.advance();this.line++;this.column=1;}else if(this.checkSeq(closing)){for(let i=0;i<closing.length;i++)this.advance();break;}else this.advance();}}}else{while(!this.isAtEnd()&&this.peek()!=='\n')this.advance();}}private isAtEnd():boolean{return this.current>=this.source.length;}private advance():string{const c=this.source[this.current];this.current++;this.column++;return c;}private peek():string{return this.isAtEnd()?'\0':this.source[this.current];}private peekNext():string{return this.current+1>=this.source.length?'\0':this.source[this.current+1];}private match(expected:string):boolean{if(this.isAtEnd()||this.source[this.current]!==expected)return false;this.current++;this.column++;return true;}private checkSeq(seq:string):boolean{for(let i=0;i<seq.length;i++){if(this.current+i>=this.source.length||this.source[this.current+i]!==seq[i])return false;}return true;}private isDigit(c:string):boolean{return c>='0'&&c<='9';}private isHexDigit(c:string):boolean{return this.isDigit(c)||(c>='a'&&c<='f')||(c>='A'&&c<='F');}private isAlpha(c:string):boolean{return(c>='a'&&c<='z')||(c>='A'&&c<='Z')||c==='_';}private isAlphaNumeric(c:string):boolean{return this.isAlpha(c)||this.isDigit(c);}private addToken(type:TokenType,literal?:any):void{const text=this.source.substring(this.start,this.current);this.tokens.push({type,value:text,literal:literal!==undefined?literal:text,line:this.line,column:this.startColumn});}}
export function tokenize(source:string):Token[]{return new Lexer(source).tokenize();}
const RESERVED=new Set(['print','type','tostring','tonumber','pairs','ipairs','next','select','unpack','pcall','xpcall','error','assert','setmetatable','getmetatable','rawget','rawset','rawequal','loadstring','load','dofile','require','collectgarbage','setfenv','getfenv','math','string','table','os','io','coroutine','debug','bit32','bit','utf8','package','game','workspace','script','plugin','wait','spawn','delay','tick','time','elapsedTime','warn','typeof','task','version','settings','Instance','Vector3','Vector2','CFrame','Color3','UDim','UDim2','Enum','Ray','Region3','Rect','BrickColor','TweenInfo','NumberSequence','ColorSequence','NumberRange','PhysicalProperties','Random','Axes','Faces','getgenv','getrenv','getrawmetatable','setrawmetatable','hookfunction','hookmetamethod','newcclosure','islclosure','iscclosure','checkcaller','getinfo','getupvalue','setupvalue','getconstant','setconstant','getconnections','firesignal','fireserver','fireclient','syn','Synapse','Drawing','request','http_request','HttpGet','HttpPost','readfile','writefile','appendfile','isfile','isfolder','makefolder','listfiles','setclipboard','identifyexecutor','getexecutorname','gethiddenproperty','sethiddenproperty','gethui','getinstances','getnilinstances','_G','_VERSION','_ENV','self','nil','true','false','shared']);
export interface RenameMap{[original:string]:string}
class NameGenerator{private usedNames=new Set<string>();private counter=0;private nameLength:number;constructor(length:number=16){this.nameLength=length;}generate():string{let name:string;do{name=this.createName(this.counter++);}while(this.usedNames.has(name));this.usedNames.add(name);return name;}private createName(index:number):string{const chars=['I','l'];let name='';let num=index;do{name=chars[num%2]+name;num=Math.floor(num/2);}while(num>0);while(name.length<this.nameLength){const padIndex=(index+name.length)%2;name=chars[padIndex]+name;}return name;}}
const STATEMENT_KEYWORDS=new Set([TokenType.LOCAL,TokenType.FUNCTION,TokenType.IF,TokenType.THEN,TokenType.ELSE,TokenType.ELSEIF,TokenType.END,TokenType.DO,TokenType.WHILE,TokenType.FOR,TokenType.REPEAT,TokenType.UNTIL,TokenType.RETURN,TokenType.BREAK,TokenType.GOTO]);
function isTableKey(tokens:Token[],index:number):boolean{const next=tokens[index+1];if(!next||next.type!==TokenType.ASSIGN)return false;let braceDepth=0;for(let j=index-1;j>=0;j--){const t=tokens[j];if(t.type===TokenType.RBRACE){braceDepth++;continue;}if(t.type===TokenType.LBRACE){if(braceDepth===0)return true;braceDepth--;continue;}if(braceDepth>0)continue;if(t.type===TokenType.SEMICOLON)return false;if(STATEMENT_KEYWORDS.has(t.type))return false;}return false;}
function analyzeIdentifiers(tokens:Token[]):Set<string>{const localVars=new Set<string>();for(let i=0;i<tokens.length;i++){const t=tokens[i];if(t.type!==TokenType.IDENTIFIER)continue;if(RESERVED.has(t.value))continue;const prev=tokens[i-1];const prev2=tokens[i-2];if(prev&&(prev.type===TokenType.DOT||prev.type===TokenType.COLON))continue;if(isTableKey(tokens,i))continue;let isLocal=false;if(prev&&prev.type===TokenType.LOCAL)isLocal=true;if(!isLocal&&prev&&prev.type===TokenType.COMMA){for(let j=i-1;j>=0;j--){const tk=tokens[j];if(tk.type===TokenType.LOCAL){isLocal=true;break;}if(tk.type===TokenType.ASSIGN||tk.type===TokenType.IN||STATEMENT_KEYWORDS.has(tk.type))break;}}if(!isLocal&&prev&&prev.type===TokenType.FUNCTION){if(prev2&&prev2.type===TokenType.LOCAL)isLocal=true;}if(!isLocal){let parenDepth=0;for(let j=i-1;j>=0;j--){const tk=tokens[j];if(tk.type===TokenType.RPAREN)parenDepth++;else if(tk.type===TokenType.LPAREN){parenDepth--;if(parenDepth<0){for(let k=j-1;k>=0;k--){if(tokens[k].type===TokenType.FUNCTION){isLocal=true;break;}if(tokens[k].type!==TokenType.IDENTIFIER)break;}break;}}else if(STATEMENT_KEYWORDS.has(tk.type))break;}}if(!isLocal){for(let j=i-1;j>=0;j--){const tk=tokens[j];if(tk.type===TokenType.FOR){isLocal=true;break;}if(tk.type===TokenType.DO||STATEMENT_KEYWORDS.has(tk.type))break;}}if(isLocal)localVars.add(t.value);}return localVars;}
export function createRenameMap(tokens:Token[],nameLength:number=16):RenameMap{const map:RenameMap={};const generator=new NameGenerator(nameLength);const localVars=analyzeIdentifiers(tokens);for(const name of localVars)map[name]=generator.generate();return map;}
export function applyRenameMap(tokens:Token[],map:RenameMap):Token[]{const result:Token[]=[];for(let i=0;i<tokens.length;i++){const t=tokens[i];if(t.type!==TokenType.IDENTIFIER||!map[t.value]){result.push(t);continue;}const prev=tokens[i-1];if(prev&&(prev.type===TokenType.DOT||prev.type===TokenType.COLON)){result.push(t);continue;}if(isTableKey(tokens,i)){result.push(t);continue;}result.push({...t,value:map[t.value],literal:map[t.value]});}return result;}
function generateXorKey():number{return Math.floor(Math.random()*200)+50;}
function generateObfuscatedName(prefix:string='',length:number=12):string{const chars=['I','l'];let name=prefix;for(let i=0;i<length;i++){name+=chars[Math.floor(Math.random()*2)];}return name;}
class FancyNumberFormatter{static toFancyFormat(num:number):string{if(num<0)return`-${this.toFancyFormat(-num)}`;if(num===0)return'0';const formats:string[]=[`0X${num.toString(16).toUpperCase()}`,`0x${num.toString(16)}`,`0B${num.toString(2)}`,`0b${num.toString(2)}`];if(num>100){const hex=num.toString(16).toUpperCase();if(hex.length>=4){const mid=Math.floor(hex.length/2);formats.push(`0X${hex.slice(0,mid)}_${hex.slice(mid)}`);}}if(num>50){const bin=num.toString(2);if(bin.length>=8){const parts:string[]=[];for(let i=0;i<bin.length;i+=4){parts.push(bin.slice(i,i+4));}formats.push(`0b${parts.join('_')}`);formats.push(`0B${parts.join('_')}`);}}return formats[Math.floor(Math.random()*formats.length)];}static toMathExpression(num:number):string{if(Math.random()<0.3){const a=Math.floor(Math.random()*100)+50;const b=num-a;return`(${this.toFancyFormat(a)}${b>=0?'+':'-'}${this.toFancyFormat(Math.abs(b))})`;}if(Math.random()<0.5&&num>10){const a=Math.floor(Math.random()*10)+2;if(num%a===0){return`(${this.toFancyFormat(a)}*${this.toFancyFormat(num/a)})`;}const b=num%a;return`(${this.toFancyFormat(a)}*${this.toFancyFormat(Math.floor(num/a))}+${this.toFancyFormat(b)})`;}return this.toFancyFormat(num);}}
class FancyStringEncoder{static toUnicodeEscape(str:string,key:number):string{let result='';for(let i=0;i<str.length;i++){const charCode=str.charCodeAt(i);const encrypted=(charCode^key)&0xFF;if(Math.random()<0.3&&encrypted<128){result+=`\\u{${encrypted.toString(16).padStart(2,'0')}}`;} else if(Math.random()<0.5){result+=`\\x${encrypted.toString(16).padStart(2,'0')}`;}else{result+=`\\${encrypted.toString(8).padStart(3,'0')}`;}}return result;}static generateRandomHexString(length:number):string{let result='';for(let i=0;i<length;i++){const v=Math.floor(Math.random()*256);if(Math.random()<0.25){result+=`\\u{${v.toString(16).padStart(2,'0')}}`;}else{result+=`\\x${v.toString(16).padStart(2,'0')}`;}}return result;}}
export interface StringEncryptionResult{encryptedStrings:Map<string,{encrypted:string;key:number}>;decryptorName:string;decryptorCode:string;xorKey:number}
export function encryptStrings(tokens:Token[]):{tokens:Token[];encryption:StringEncryptionResult}{const encryptedStrings=new Map<string,{encrypted:string;key:number}>();const decryptorName=generateObfuscatedName('_',16);const globalKey=generateXorKey();const result:Token[]=[];for(let i=0;i<tokens.length;i++){const t=tokens[i];if(t.type===TokenType.STRING&&typeof t.literal==='string'&&t.literal.length>0){const original=t.literal;const encrypted=FancyStringEncoder.toUnicodeEscape(original,globalKey);encryptedStrings.set(original,{encrypted,key:globalKey});result.push({type:TokenType.IDENTIFIER,value:decryptorName,line:t.line,column:t.column});result.push({type:TokenType.LPAREN,value:'(',line:t.line,column:t.column});result.push({type:TokenType.STRING,value:`"${encrypted}"`,literal:encrypted,line:t.line,column:t.column});result.push({type:TokenType.COMMA,value:',',line:t.line,column:t.column});const keyStr=FancyNumberFormatter.toFancyFormat(globalKey);result.push({type:TokenType.NUMBER,value:keyStr,literal:globalKey,line:t.line,column:t.column});result.push({type:TokenType.RPAREN,value:')',line:t.line,column:t.column});}else{result.push(t);}}const decryptorCode=`local ${decryptorName}=(function() local b=bit32 or bit local x=b and b.bxor or function(a,c) local r,p=0,1 while a>0 or c>0 do if a%2~=c%2 then r=r+p end a,c,p=math.floor(a/2),math.floor(c/2),p*2 end return r end return function(s,k) local o="" for i=1,#s do o=o..string.char(x(s:byte(i),k)) end return o end end)()`;return{tokens:result,encryption:{encryptedStrings,decryptorName,decryptorCode,xorKey:globalKey}};}
const SKIP_PROPERTIES=new Set(['new','Create','clone','Clone','Destroy','destroy','Parent','parent','Name','name','Value','value','Text','text','Visible','visible','Enabled','enabled','Position','position','Size','size','Color','color','Transparency','CFrame','Anchored','CanCollide','Character','Humanoid','Health','WalkSpeed','JumpPower','Hit','Target','Mouse','Keyboard','InputBegan','InputEnded','Touched','Changed','ChildAdded','ChildRemoved','AncestryChanged','GetPropertyChangedSignal','Wait','Connect','Disconnect','Once','Fire','Invoke','BindToRenderStep','UnbindFromRenderStep','Heartbeat','Stepped','RenderStepped']);
export function obfuscatePropertyAccess(tokens:Token[],decryptorName:string,xorKey:number):{tokens:Token[];propertiesObfuscated:number}{const result:Token[]=[];let count=0;for(let i=0;i<tokens.length;i++){const t=tokens[i];const next=tokens[i+1];if(t.type===TokenType.DOT&&next?.type===TokenType.IDENTIFIER){const propName=next.value;if(propName.length<=2||SKIP_PROPERTIES.has(propName)){result.push(t);continue;}const encrypted=FancyStringEncoder.toUnicodeEscape(propName,xorKey);result.push({type:TokenType.LBRACKET,value:'[',line:t.line,column:t.column});result.push({type:TokenType.IDENTIFIER,value:decryptorName,line:t.line,column:t.column});result.push({type:TokenType.LPAREN,value:'(',line:t.line,column:t.column});result.push({type:TokenType.STRING,value:`"${encrypted}"`,literal:encrypted,line:t.line,column:t.column});result.push({type:TokenType.COMMA,value:',',line:t.line,column:t.column});const keyStr=FancyNumberFormatter.toFancyFormat(xorKey);result.push({type:TokenType.NUMBER,value:keyStr,literal:xorKey,line:t.line,column:t.column});result.push({type:TokenType.RPAREN,value:')',line:t.line,column:t.column});result.push({type:TokenType.RBRACKET,value:']',line:t.line,column:t.column});i++;count++;}else{result.push(t);}}return{tokens:result,propertiesObfuscated:count};}
export function obfuscateTableKeys(tokens:Token[],decryptorName:string,xorKey:number):{tokens:Token[];keysObfuscated:number}{const result:Token[]=[];let count=0;for(let i=0;i<tokens.length;i++){const t=tokens[i];if(t.type===TokenType.IDENTIFIER&&isTableKey(tokens,i)&&t.value.length>2){const encrypted=FancyStringEncoder.toUnicodeEscape(t.value,xorKey);result.push({type:TokenType.LBRACKET,value:'[',line:t.line,column:t.column});result.push({type:TokenType.IDENTIFIER,value:decryptorName,line:t.line,column:t.column});result.push({type:TokenType.LPAREN,value:'(',line:t.line,column:t.column});result.push({type:TokenType.STRING,value:`"${encrypted}"`,literal:encrypted,line:t.line,column:t.column});result.push({type:TokenType.COMMA,value:',',line:t.line,column:t.column});const keyStr=FancyNumberFormatter.toFancyFormat(xorKey);result.push({type:TokenType.NUMBER,value:keyStr,literal:xorKey,line:t.line,column:t.column});result.push({type:TokenType.RPAREN,value:')',line:t.line,column:t.column});result.push({type:TokenType.RBRACKET,value:']',line:t.line,column:t.column});count++;}else{result.push(t);}}return{tokens:result,keysObfuscated:count};}
class NumberObfuscator{private complexity:number;constructor(complexity:number=3){this.complexity=complexity;}obfuscateNumber(num:number):string{if(Number.isNaN(num))return'(0/0)';if(num===Infinity)return'(1/0)';if(num===-Infinity)return'(-1/0)';if(Number.isInteger(num))return this.obfuscateInteger(num);return this.obfuscateFloat(num);}private obfuscateInteger(num:number):string{if(this.complexity>=3){return this.complexObfuscation(num);}return FancyNumberFormatter.toMathExpression(num);}private complexObfuscation(num:number):string{const a=Math.floor(Math.random()*1000)+100;const b=Math.floor(Math.random()*1000)+100;const c=Math.floor(Math.random()*100)+10;const d=num-((a+b)*c-a*c-b*c);const aStr=FancyNumberFormatter.toFancyFormat(a);const bStr=FancyNumberFormatter.toFancyFormat(b);const cStr=FancyNumberFormatter.toFancyFormat(c);const dStr=d>=0?FancyNumberFormatter.toFancyFormat(d):`(${FancyNumberFormatter.toFancyFormat(-d)})`;return`((${aStr}+${bStr})*${cStr}-${aStr}*${cStr}-${bStr}*${cStr}+${d>=0?dStr:`-${FancyNumberFormatter.toFancyFormat(-d)}`})`;}private obfuscateFloat(num:number):string{const precision=1000000;const numerator=Math.round(num*precision);const gcd=this.gcd(Math.abs(numerator),precision);return`(${FancyNumberFormatter.toFancyFormat(numerator/gcd)}/${FancyNumberFormatter.toFancyFormat(precision/gcd)})`;}private gcd(a:number,b:number):number{return b===0?a:this.gcd(b,a%b);}}
export function obfuscateNumbers(tokens:Token[],complexity:number=3):{tokens:Token[];numbersObfuscated:number}{const obfuscator=new NumberObfuscator(complexity);const result:Token[]=[];let numbersObfuscated=0;for(let i=0;i<tokens.length;i++){const t=tokens[i];if(t.type===TokenType.NUMBER&&typeof t.literal==='number'){const num=t.literal;let inForLoop=false;for(let j=i-1;j>=Math.max(0,i-15);j--){if(tokens[j].type===TokenType.FOR){inForLoop=true;break;}if(tokens[j].type===TokenType.DO)break;}if(inForLoop){result.push(t);continue;}const prev=tokens[i-1];if(prev?.type===TokenType.LBRACKET&&num>=1&&num<=10&&Number.isInteger(num)){result.push(t);continue;}const obfuscated=obfuscator.obfuscateNumber(num);const exprTokens=expressionToTokens(obfuscated,t.line,t.column);result.push(...exprTokens);numbersObfuscated++;}else{result.push(t);}}return{tokens:result,numbersObfuscated};}
function expressionToTokens(expr:string,line:number,column:number):Token[]{const result:Token[]=[];let i=0;while(i<expr.length){const c=expr[i];if(c===' '||c==='_'){i++;continue;}if(c==='('){result.push({type:TokenType.LPAREN,value:'(',line,column});i++;}else if(c===')'){result.push({type:TokenType.RPAREN,value:')',line,column});i++;}else if(c==='+'){result.push({type:TokenType.PLUS,value:'+',line,column});i++;}else if(c==='*'){result.push({type:TokenType.STAR,value:'*',line,column});i++;}else if(c==='-'){result.push({type:TokenType.MINUS,value:'-',line,column});i++;}else if(c==='/'){result.push({type:TokenType.SLASH,value:'/',line,column});i++;}else if(/[0-9]/.test(c)||c==='0'){let numStr='';if(c==='0'&&(expr[i+1]?.toLowerCase()==='x'||expr[i+1]?.toLowerCase()==='b')){numStr=expr[i]+expr[i+1];i+=2;while(i<expr.length&&(/[0-9a-fA-F_]/.test(expr[i]))){if(expr[i]!=='_')numStr+=expr[i];i++;}const base=numStr[1].toLowerCase()==='x'?16:2;result.push({type:TokenType.NUMBER,value:numStr,literal:parseInt(numStr.slice(2),base),line,column});}else{while(i<expr.length&&/[0-9._]/.test(expr[i])){if(expr[i]!=='_')numStr+=expr[i];i++;}result.push({type:TokenType.NUMBER,value:numStr,literal:parseFloat(numStr),line,column});}}else{i++;}}return result;}
class OpaquePredicateGenerator{private varCounter=0;private nameLength:number;constructor(nameLength:number=16){this.nameLength=nameLength;}private generateVarName():string{const chars=['_','I','l'];let name='_'+chars[Math.floor(Math.random()*3)];for(let i=0;i<this.nameLength;i++){name+=chars[Math.floor(Math.random()*2)+1];}name+=this.varCounter++;return name;}generateTruePredicate():{condition:string;setup:string}{const strategies=[()=>{const v=this.generateVarName();const n=Math.floor(Math.random()*100)+1;return{setup:`local ${v}=${FancyNumberFormatter.toFancyFormat(n)}`,condition:`(${v}*${v}>=${FancyNumberFormatter.toFancyFormat(0)})`};},()=>{const v=this.generateVarName();return{setup:`local ${v}=${FancyNumberFormatter.toFancyFormat(1)}`,condition:`(type(${v})=="number")`};},()=>{const v=this.generateVarName();return{setup:`local ${v}=""`,condition:`(#${v}>=${FancyNumberFormatter.toFancyFormat(0)})`};}];return strategies[Math.floor(Math.random()*strategies.length)]();}generateFalsePredicate():{condition:string;setup:string}{const strategies=[()=>{const v=this.generateVarName();const n=Math.floor(Math.random()*100)+1;return{setup:`local ${v}=${FancyNumberFormatter.toFancyFormat(n)}`,condition:`(${v}<${FancyNumberFormatter.toFancyFormat(0)} and ${v}>${FancyNumberFormatter.toFancyFormat(0)})`};},()=>{const v=this.generateVarName();return{setup:`local ${v}=${FancyNumberFormatter.toFancyFormat(1)}`,condition:`(type(${v})=="string")`};}];return strategies[Math.floor(Math.random()*strategies.length)]();}}
class DeadCodeGenerator{private varCounter=0;private nameLength:number;constructor(nameLength:number=16){this.nameLength=nameLength;}private generateVarName():string{const chars=['I','l'];let name='';for(let i=0;i<this.nameLength;i++){name+=chars[Math.floor(Math.random()*2)];}name+='_'+this.varCounter++;return name;}generateDeadCode():string{const strategies=[()=>{const v=this.generateVarName();return`local ${v}=${FancyNumberFormatter.toFancyFormat(Math.floor(Math.random()*1000))}`;},()=>{const v=this.generateVarName();return`local ${v}=function() end`;},()=>{const v=this.generateVarName();return`local ${v}={}`;}];return strategies[Math.floor(Math.random()*strategies.length)]();}generateDeadBlock():string{const lines:string[]=[];const count=Math.floor(Math.random()*3)+2;for(let i=0;i<count;i++){lines.push(this.generateDeadCode());}return lines.join(';');}}
export function injectOpaquePredicates(tokens:Token[],config:{insertionRate?:number;nameLength?:number}={}):{tokens:Token[];predicatesInserted:number;deadCodeInserted:number}{const cfg={insertionRate:config.insertionRate??0.3,nameLength:config.nameLength??16};const opaqueGen=new OpaquePredicateGenerator(cfg.nameLength);const deadGen=new DeadCodeGenerator(cfg.nameLength);const result:Token[]=[];let predicatesInserted=0;let deadCodeInserted=0;const insertionPoints:number[]=[];for(let i=0;i<tokens.length;i++){const t=tokens[i];if(t.type===TokenType.THEN||t.type===TokenType.DO||t.type===TokenType.ELSE){if(Math.random()<cfg.insertionRate){insertionPoints.push(i);}}}for(let i=0;i<tokens.length;i++){const t=tokens[i];result.push(t);if(insertionPoints.includes(i)){const insertDeadCode=Math.random()<0.5;if(insertDeadCode){const falsePred=opaqueGen.generateFalsePredicate();const deadCode=deadGen.generateDeadBlock();const injection=`${falsePred.setup};if ${falsePred.condition} then ${deadCode} end`;const injTokens=tokenize(injection);injTokens.pop();result.push(...injTokens);predicatesInserted++;deadCodeInserted++;}else{const truePred=opaqueGen.generateTruePredicate();const injTokens=tokenize(truePred.setup);injTokens.pop();result.push(...injTokens);predicatesInserted++;}}}return{tokens:result,predicatesInserted,deadCodeInserted};}
interface CFBlock{id:number;tokens:Token[];nextState:number|null}
class ControlFlowFlattener{private stateVarName:string;private blocks:CFBlock[]=[];constructor(nameLength:number=16){this.stateVarName=this.generateStateVarName(nameLength);}private generateStateVarName(length:number):string{const chars=['I','l'];let name='_';for(let i=0;i<length;i++){name+=chars[Math.floor(Math.random()*2)];}return name;}private shuffleArray<T>(array:T[]):T[]{const result=[...array];for(let i=result.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[result[i],result[j]]=[result[j],result[i]];}return result;}flattenFunction(bodyTokens:Token[]):Token[]{this.blocks=[];const segments=this.splitIntoSegments(bodyTokens);if(segments.length<2)return bodyTokens;let stateId=1;for(const seg of segments){this.blocks.push({id:stateId,tokens:seg,nextState:stateId<segments.length?stateId+1:0});stateId++;}return this.generateStateMachine();}private splitIntoSegments(tokens:Token[]):Token[][]{const segments:Token[][]=[];let current:Token[]=[];let depth=0;let parenDepth=0;let bracketDepth=0;let braceDepth=0;for(let i=0;i<tokens.length;i++){const t=tokens[i];if(t.type===TokenType.IF||t.type===TokenType.WHILE||t.type===TokenType.FOR||t.type===TokenType.FUNCTION||t.type===TokenType.REPEAT||t.type===TokenType.DO)depth++;if(t.type===TokenType.END||t.type===TokenType.UNTIL)depth--;if(t.type===TokenType.LPAREN)parenDepth++;if(t.type===TokenType.RPAREN)parenDepth--;if(t.type===TokenType.LBRACKET)bracketDepth++;if(t.type===TokenType.RBRACKET)bracketDepth--;if(t.type===TokenType.LBRACE)braceDepth++;if(t.type===TokenType.RBRACE)braceDepth--;current.push(t);const allClosed=depth===0&&parenDepth===0&&bracketDepth===0&&braceDepth===0;const canSplit=t.type===TokenType.END||i===tokens.length-1||(tokens[i+1]&&tokens[i+1].type===TokenType.LOCAL);if(allClosed&&current.length>3&&canSplit){segments.push(current);current=[];}}if(current.length>0)segments.push(current);return segments;}private generateStateMachine():Token[]{const result:Token[]=[];const shuffled=this.shuffleArray(this.blocks);const init=this.blocks.length>0?this.blocks[0].id:0;result.push(...tokenize(`local ${this.stateVarName}=${FancyNumberFormatter.toFancyFormat(init)}`).slice(0,-1));result.push(...tokenize(`while ${this.stateVarName}~=${FancyNumberFormatter.toFancyFormat(0)} do `).slice(0,-1));for(let i=0;i<shuffled.length;i++){const block=shuffled[i];const kw=i===0?'if':'elseif';result.push(...tokenize(`${kw} ${this.stateVarName}==${FancyNumberFormatter.toFancyFormat(block.id)} then `).slice(0,-1));result.push(...block.tokens);result.push(...tokenize(`;${this.stateVarName}=${FancyNumberFormatter.toFancyFormat(block.nextState??0)};`).slice(0,-1));}result.push(...tokenize(` end end`).slice(0,-1));return result;}}
export function flattenControlFlow(tokens:Token[],config:{flattenRate?:number;minStatements?:number;nameLength?:number}={}):{tokens:Token[];functionsFlattened:number}{const cfg={flattenRate:config.flattenRate??0.5,minStatements:config.minStatements??3,nameLength:config.nameLength??16};const result:Token[]=[];let functionsFlattened=0;let i=0;while(i<tokens.length){const t=tokens[i];if(t.type===TokenType.FUNCTION){result.push(t);i++;while(i<tokens.length&&tokens[i].type!==TokenType.LPAREN){result.push(tokens[i]);i++;}if(i<tokens.length){result.push(tokens[i]);i++;}let parenDepth=1;while(i<tokens.length&&parenDepth>0){if(tokens[i].type===TokenType.LPAREN)parenDepth++;if(tokens[i].type===TokenType.RPAREN)parenDepth--;result.push(tokens[i]);i++;}const bodyTokens:Token[]=[];let depth=1;while(i<tokens.length&&depth>0){const tk=tokens[i];if(tk.type===TokenType.FUNCTION||tk.type===TokenType.IF||tk.type===TokenType.WHILE||tk.type===TokenType.FOR||tk.type===TokenType.REPEAT||tk.type===TokenType.DO)depth++;if(tk.type===TokenType.END||tk.type===TokenType.UNTIL){depth--;if(depth===0)break;}bodyTokens.push(tk);i++;}let hasAnonymousFunc=false;let pDepth=0;for(let j=0;j<bodyTokens.length;j++){const tk=bodyTokens[j];if(tk.type===TokenType.LPAREN)pDepth++;if(tk.type===TokenType.RPAREN)pDepth--;if(tk.type===TokenType.FUNCTION&&pDepth>0){hasAnonymousFunc=true;break;}}if(bodyTokens.length>=cfg.minStatements&&Math.random()<cfg.flattenRate&&!hasAnonymousFunc){const flattener=new ControlFlowFlattener(cfg.nameLength);result.push(...flattener.flattenFunction(bodyTokens));functionsFlattened++;}else{result.push(...bodyTokens);}if(i<tokens.length){result.push(tokens[i]);i++;}}else{result.push(t);i++;}}return{tokens:result,functionsFlattened};}
const PROXYABLE_FUNCTIONS=['print','warn','error','type','typeof','tostring','tonumber','pairs','ipairs','next','select','unpack','pcall','xpcall','assert','setmetatable','getmetatable','rawget','rawset','rawequal','loadstring','require'];
class GarbageFunctionGenerator{private counter=0;private nameLength:number;constructor(nameLength:number=16){this.nameLength=nameLength;}private generateName():string{const chars=['I','l'];let name='_G';for(let i=0;i<this.nameLength;i++){name+=chars[Math.floor(Math.random()*2)];}name+=this.counter++;return name;}generateGarbageFunction():string{const name=this.generateName();const params=this.generateParams();const body=this.generateBody();return`local function ${name}(${params}) ${body} end`;}private generateParams():string{const count=Math.floor(Math.random()*4)+1;const params:string[]=[];for(let i=0;i<count;i++){params.push(String.fromCharCode(97+i));}return params.join(',');}private generateBody():string{const v=this.generateName();const strategies=[()=>`local ${v}=${FancyNumberFormatter.toFancyFormat(0)};for i=1,${FancyNumberFormatter.toFancyFormat(100)} do ${v}=${v}+i end;return ${v}`,()=>`local ${v}={};for i=1,${FancyNumberFormatter.toFancyFormat(50)} do ${v}[i]=i*${FancyNumberFormatter.toFancyFormat(2)} end;return ${v}`,()=>{const v2=this.generateName();return`local ${v},${v2}=${FancyNumberFormatter.toFancyFormat(0)},${FancyNumberFormatter.toFancyFormat(1)};for i=1,${FancyNumberFormatter.toFancyFormat(20)} do ${v},${v2}=${v2},${v}+${v2} end;return ${v}`;},()=>`if a then return a elseif b then return b else return c or ${FancyNumberFormatter.toFancyFormat(0)} end`,()=>`local ${v}=a or ${FancyNumberFormatter.toFancyFormat(0)};${v}=${v}*${FancyNumberFormatter.toFancyFormat(2)}+${FancyNumberFormatter.toFancyFormat(1)};${v}=${v}-(b or ${FancyNumberFormatter.toFancyFormat(0)});return ${v}`,()=>`local ${v}="";for i=1,${FancyNumberFormatter.toFancyFormat(10)} do ${v}=${v}..tostring(i) end;return ${v}`,()=>`return (a or ${FancyNumberFormatter.toFancyFormat(0)})+(b or ${FancyNumberFormatter.toFancyFormat(0)})+(c or ${FancyNumberFormatter.toFancyFormat(0)})+(d or ${FancyNumberFormatter.toFancyFormat(0)})`,()=>`local ${v}=type(a)=="number" and a*${FancyNumberFormatter.toFancyFormat(2)} or ${FancyNumberFormatter.toFancyFormat(0)};return ${v}`];return strategies[Math.floor(Math.random()*strategies.length)]();}generateMultiple(count:number):string{const funcs:string[]=[];for(let i=0;i<count;i++){funcs.push(this.generateGarbageFunction());}return funcs.join(';');}}
class BulkDataGenerator{private counter=0;private nameLength:number;constructor(nameLength:number=16){this.nameLength=nameLength;}private generateName():string{const chars=['I','l'];let name='_D';for(let i=0;i<this.nameLength;i++){name+=chars[Math.floor(Math.random()*2)];}name+=this.counter++;return name;}generateDataTable(size:number):string{const name=this.generateName();const entries:string[]=[];for(let i=0;i<size;i++){const key=Math.floor(Math.random()*10000);const val=Math.floor(Math.random()*100000);entries.push(`[${FancyNumberFormatter.toFancyFormat(key)}]=${FancyNumberFormatter.toFancyFormat(val)}`);}return`local ${name}={${entries.join(',')}}`;}generateStringTable(count:number):string{const name=this.generateName();const entries:string[]=[];for(let i=0;i<count;i++){const str=FancyStringEncoder.generateRandomHexString(32);entries.push(`"${str}"`)}return`local ${name}={${entries.join(',')}}`;}generateMultiple(tableCount:number,tableSize:number):string{const tables:string[]=[];for(let i=0;i<tableCount;i++){if(Math.random()<0.5){tables.push(this.generateDataTable(tableSize));}else{tables.push(this.generateStringTable(Math.floor(tableSize/2)));}}return tables.join(';');}}
class VMWrapperGenerator{private nameLength:number;constructor(nameLength:number=16){this.nameLength=nameLength;}private generateName(prefix:string):string{const chars=['I','l'];let name=prefix;for(let i=0;i<this.nameLength;i++){name+=chars[Math.floor(Math.random()*2)];}return name;}generateVMStructure():string{const names={vm:this.generateName('_VM'),reg:this.generateName('_REG'),stk:this.generateName('_STK'),pc:this.generateName('_PC'),ops:this.generateName('_OPS'),mem:this.generateName('_MEM'),ctx:this.generateName('_CTX')};const code=`local ${names.vm}=(function()
local ${names.reg}={};
local ${names.stk}={};
local ${names.pc}=${FancyNumberFormatter.toFancyFormat(1)};
local ${names.ops}={
[${FancyNumberFormatter.toFancyFormat(1)}]=function(a,b) return a+b end,
[${FancyNumberFormatter.toFancyFormat(2)}]=function(a,b) return a-b end,
[${FancyNumberFormatter.toFancyFormat(3)}]=function(a,b) return a*b end,
[${FancyNumberFormatter.toFancyFormat(4)}]=function(a,b) return a/b end,
[${FancyNumberFormatter.toFancyFormat(5)}]=function(a,b) return a%b end,
[${FancyNumberFormatter.toFancyFormat(6)}]=function(a,b) return a^b end,
[${FancyNumberFormatter.toFancyFormat(7)}]=function(a,b) return a..b end,
[${FancyNumberFormatter.toFancyFormat(8)}]=function(a,b) return a==b end,
[${FancyNumberFormatter.toFancyFormat(9)}]=function(a,b) return a<b end,
[${FancyNumberFormatter.toFancyFormat(10)}]=function(a,b) return a<=b end
};
return function(op,a,b)
if ${names.ops}[op] then return ${names.ops}[op](a,b) end;
return nil
end
end)()`;return code;}generateOpcodeTable(size:number):string{const name=this.generateName('_OP');const entries:string[]=[];for(let i=0;i<size;i++){const opcode=Math.floor(Math.random()*256);const arg1=Math.floor(Math.random()*1000);const arg2=Math.floor(Math.random()*1000);entries.push(`{${FancyNumberFormatter.toFancyFormat(opcode)},${FancyNumberFormatter.toFancyFormat(arg1)},${FancyNumberFormatter.toFancyFormat(arg2)}}`);}return`local ${name}={${entries.join(',')}}`;}generateConstants(count:number):string{const name=this.generateName('_K');const entries:string[]=[];for(let i=0;i<count;i++){if(Math.random()<0.3){entries.push(`"${FancyStringEncoder.generateRandomHexString(20)}"`);}else if(Math.random()<0.6){entries.push(FancyNumberFormatter.toFancyFormat(Math.floor(Math.random()*100000)));}else{entries.push(Math.random()<0.5?'true':'false');}}return`local ${name}={${entries.join(',')}}`;}generateWhileLoopPattern():string{const v=this.generateName('_');const cond=this.generateName('_c');return`local ${v}=${FancyNumberFormatter.toFancyFormat(Math.floor(Math.random()*100)+50)};
local ${cond}=nil;
${v}=(${FancyNumberFormatter.toFancyFormat(0)});
while true do
if ${v}==${FancyNumberFormatter.toFancyFormat(0)} then ${cond}=${v};break end;
${v}=${v}-${FancyNumberFormatter.toFancyFormat(1)};
end`;}}
export interface FunctionProxyResult{proxyTableName:string;proxyCode:string;functionsProxied:number}
export function createFunctionProxy(tokens:Token[],nameLength:number=16):{tokens:Token[];proxy:FunctionProxyResult}{const proxyTableName=generateObfuscatedName('_P',nameLength);const usedFunctions=new Set<string>();for(const t of tokens){if(t.type===TokenType.IDENTIFIER&&PROXYABLE_FUNCTIONS.includes(t.value)){usedFunctions.add(t.value);}}if(usedFunctions.size===0){return{tokens,proxy:{proxyTableName,proxyCode:'',functionsProxied:0}};}const proxyMap:Record<string,string>={};const entries:string[]=[];let idx=0;for(const fn of usedFunctions){const key=String.fromCharCode(97+idx%26)+(idx>=26?String(Math.floor(idx/26)):'');proxyMap[fn]=key;entries.push(`${key}=${fn}`);idx++;}const proxyCode=`local ${proxyTableName}={${entries.join(',')}}`;const result:Token[]=[];for(let i=0;i<tokens.length;i++){const t=tokens[i];if(t.type===TokenType.IDENTIFIER&&proxyMap[t.value]){const prev=tokens[i-1];if(prev&&(prev.type===TokenType.DOT||prev.type===TokenType.COLON)){result.push(t);continue;}result.push({type:TokenType.IDENTIFIER,value:proxyTableName,line:t.line,column:t.column});result.push({type:TokenType.DOT,value:'.',line:t.line,column:t.column});result.push({type:TokenType.IDENTIFIER,value:proxyMap[t.value],line:t.line,column:t.column});}else{result.push(t);}}return{tokens:result,proxy:{proxyTableName,proxyCode,functionsProxied:usedFunctions.size}};}
export function injectGarbageFunctions(count:number,nameLength:number=16):string{const generator=new GarbageFunctionGenerator(nameLength);return generator.generateMultiple(count);}
export function injectBulkData(tableCount:number,tableSize:number,nameLength:number=16):string{const generator=new BulkDataGenerator(nameLength);return generator.generateMultiple(tableCount,tableSize);}
export function injectVMWrapper(opcodeCount:number,constantCount:number,nameLength:number=16):string{const generator=new VMWrapperGenerator(nameLength);const parts:string[]=[];parts.push(generator.generateVMStructure());parts.push(generator.generateOpcodeTable(opcodeCount));parts.push(generator.generateConstants(constantCount));for(let i=0;i<3;i++){parts.push(generator.generateWhileLoopPattern());}return parts.join(';\n');}
function generateHeader(version:string='15.2.1'):string{return`-- Nephilim Protected | Build ${version} | https://github.com/nephilim-obf
-- Timestamp: ${new Date().toISOString()}
-- ⚠️ Tampering with this code will result in undefined behavior

`;}
function generateReturnWrapper(innerCode:string,nameLength:number=16):string{const names={m:generateObfuscatedName('',4),H:generateObfuscatedName('',4),T:generateObfuscatedName('',4),bc:generateObfuscatedName('',4),o:generateObfuscatedName('',4),u:generateObfuscatedName('',4),g:generateObfuscatedName('',4)};return`return(function()
local ${names.m}=select;
local ${names.H}=type;
local ${names.T}=unpack or table.unpack;
local ${names.bc}=coroutine.wrap;
local ${names.o}=getfenv or function() return _ENV end;
local ${names.u}=setmetatable;
local ${names.g}=tonumber;

${innerCode}
end)()`;}
const KEYWORDS_NEED_SPACE_AFTER=new Set([TokenType.LOCAL,TokenType.FUNCTION,TokenType.IF,TokenType.THEN,TokenType.ELSE,TokenType.ELSEIF,TokenType.WHILE,TokenType.DO,TokenType.FOR,TokenType.IN,TokenType.RETURN,TokenType.AND,TokenType.OR,TokenType.NOT,TokenType.END,TokenType.UNTIL,TokenType.REPEAT,TokenType.BREAK,TokenType.GOTO]);
const SPACE_AFTER=new Set([...KEYWORDS_NEED_SPACE_AFTER,TokenType.IDENTIFIER,TokenType.NUMBER,TokenType.STRING,TokenType.TRUE,TokenType.FALSE,TokenType.NIL,TokenType.RPAREN,TokenType.RBRACE,TokenType.RBRACKET]);
const SPACE_BEFORE=new Set([TokenType.IDENTIFIER,TokenType.NUMBER,TokenType.STRING,TokenType.TRUE,TokenType.FALSE,TokenType.NIL,TokenType.FUNCTION,TokenType.IF,TokenType.THEN,TokenType.ELSE,TokenType.END,TokenType.LOCAL,TokenType.RETURN,TokenType.AND,TokenType.OR,TokenType.NOT,TokenType.DO,TokenType.WHILE,TokenType.FOR,TokenType.IN,TokenType.UNTIL,TokenType.REPEAT,TokenType.ELSEIF,TokenType.LBRACE]);
const NO_SPACE_AFTER=new Set([TokenType.LPAREN,TokenType.LBRACE,TokenType.LBRACKET,TokenType.DOT,TokenType.COLON,TokenType.HASH]);
const NO_SPACE_BEFORE=new Set([TokenType.RPAREN,TokenType.RBRACE,TokenType.RBRACKET,TokenType.DOT,TokenType.COLON,TokenType.COMMA,TokenType.SEMICOLON,TokenType.LPAREN,TokenType.LBRACKET]);
export function tokensToCode(tokens:Token[],prependCode:string='',formatted:boolean=true):string{let code=prependCode?prependCode+(formatted?'\n\n':' '):'';let lineLength=0;const maxLineLength=120;for(let i=0;i<tokens.length;i++){const t=tokens[i];const prev=tokens[i-1];if(t.type===TokenType.EOF)continue;if(prev&&prev.type!==TokenType.EOF){let needsSpace=false;if(KEYWORDS_NEED_SPACE_AFTER.has(prev.type)){needsSpace=true;}else if(!NO_SPACE_AFTER.has(prev.type)&&!NO_SPACE_BEFORE.has(t.type)){if(SPACE_AFTER.has(prev.type)||SPACE_BEFORE.has(t.type)){needsSpace=true;}}if(needsSpace){code+=' ';lineLength++;}}let tokenStr='';if(t.type===TokenType.STRING){if(t.value.startsWith('"')||t.value.startsWith("'")){tokenStr=t.value;}else{const escaped=(t.literal??'').replace(/\\/g,'\\\\').replace(/"/g,'\\"').replace(/\n/g,'\\n').replace(/\r/g,'\\r').replace(/\t/g,'\\t');tokenStr='"'+escaped+'"';}}else{tokenStr=t.value;}code+=tokenStr;lineLength+=tokenStr.length;if(formatted&&(t.type===TokenType.SEMICOLON||t.type===TokenType.END)&&lineLength>maxLineLength){code+='\n';lineLength=0;}}return code;}
export interface ObfuscateOptions{debug?:boolean;renameVariables?:boolean;encryptStrings?:boolean;obfuscateNumbers?:boolean;numberComplexity?:number;insertOpaquePredicates?:boolean;opaqueInsertionRate?:number;obfuscateProperties?:boolean;obfuscateTableKeys?:boolean;flattenControlFlow?:boolean;flattenRate?:number;proxyFunctions?:boolean;garbageFunctions?:number;bulkDataTables?:number;bulkDataSize?:number;vmOpcodes?:number;vmConstants?:number;nameLength?:number;addHeader?:boolean;wrapInReturn?:boolean;formatted?:boolean}
export interface ObfuscateResult{code:string;map:RenameMap;stats:{originalTokens:number;identifiersRenamed:number;stringsEncrypted:number;numbersObfuscated:number;predicatesInserted:number;deadCodeInserted:number;propertiesObfuscated:number;tableKeysObfuscated:number;functionsFlattened:number;functionsProxied:number;garbageFunctionsAdded:number;bulkDataAdded:number;originalLength:number;outputLength:number;timeMs:number};debugLogs?:DebugLog[]}
export function obfuscate(source:string,options:ObfuscateOptions={}):ObfuscateResult{const startTime=Date.now();const opts={debug:options.debug??false,renameVariables:options.renameVariables??true,encryptStrings:options.encryptStrings??true,obfuscateNumbers:options.obfuscateNumbers??true,numberComplexity:options.numberComplexity??3,insertOpaquePredicates:options.insertOpaquePredicates??true,opaqueInsertionRate:options.opaqueInsertionRate??0.4,obfuscateProperties:options.obfuscateProperties??true,obfuscateTableKeys:options.obfuscateTableKeys??true,flattenControlFlow:options.flattenControlFlow??true,flattenRate:options.flattenRate??0.5,proxyFunctions:options.proxyFunctions??true,garbageFunctions:options.garbageFunctions??50,bulkDataTables:options.bulkDataTables??20,bulkDataSize:options.bulkDataSize??100,vmOpcodes:options.vmOpcodes??200,vmConstants:options.vmConstants??150,nameLength:options.nameLength??20,addHeader:options.addHeader??true,wrapInReturn:options.wrapInReturn??true,formatted:options.formatted??true};enableDebug(opts.debug);debug('MAIN','Nephilim v0.9.5 - Luraph Style');let tokens=tokenize(source);const originalTokenCount=tokens.length;let renameMap:RenameMap={};if(opts.renameVariables){renameMap=createRenameMap(tokens,opts.nameLength);tokens=applyRenameMap(tokens,renameMap);}let stringsEncrypted=0;let prependCode='';let decryptorName='';let xorKey=0;if(opts.encryptStrings){const encResult=encryptStrings(tokens);tokens=encResult.tokens;prependCode=encResult.encryption.decryptorCode;decryptorName=encResult.encryption.decryptorName;xorKey=encResult.encryption.xorKey;stringsEncrypted=encResult.encryption.encryptedStrings.size;}let propertiesObfuscated=0;if(opts.obfuscateProperties&&decryptorName){const propResult=obfuscatePropertyAccess(tokens,decryptorName,xorKey);tokens=propResult.tokens;propertiesObfuscated=propResult.propertiesObfuscated;}let tableKeysObfuscated=0;if(opts.obfuscateTableKeys&&decryptorName){const keyResult=obfuscateTableKeys(tokens,decryptorName,xorKey);tokens=keyResult.tokens;tableKeysObfuscated=keyResult.keysObfuscated;}let numbersObfuscated=0;if(opts.obfuscateNumbers){const numResult=obfuscateNumbers(tokens,opts.numberComplexity);tokens=numResult.tokens;numbersObfuscated=numResult.numbersObfuscated;}let predicatesInserted=0;let deadCodeInserted=0;if(opts.insertOpaquePredicates){const opaqueResult=injectOpaquePredicates(tokens,{insertionRate:opts.opaqueInsertionRate,nameLength:opts.nameLength});tokens=opaqueResult.tokens;predicatesInserted=opaqueResult.predicatesInserted;deadCodeInserted=opaqueResult.deadCodeInserted;}let functionsFlattened=0;if(opts.flattenControlFlow){const cffResult=flattenControlFlow(tokens,{flattenRate:opts.flattenRate,minStatements:3,nameLength:opts.nameLength});tokens=cffResult.tokens;functionsFlattened=cffResult.functionsFlattened;}let functionsProxied=0;if(opts.proxyFunctions){const proxyResult=createFunctionProxy(tokens,opts.nameLength);tokens=proxyResult.tokens;if(proxyResult.proxy.proxyCode){prependCode=prependCode+';\n'+proxyResult.proxy.proxyCode;}functionsProxied=proxyResult.proxy.functionsProxied;}let garbageFunctionsAdded=0;if(opts.garbageFunctions&&opts.garbageFunctions>0){const garbageCode=injectGarbageFunctions(opts.garbageFunctions,opts.nameLength);prependCode=prependCode+';\n'+garbageCode;garbageFunctionsAdded=opts.garbageFunctions;}let bulkDataAdded=0;if(opts.bulkDataTables&&opts.bulkDataTables>0){const bulkCode=injectBulkData(opts.bulkDataTables,opts.bulkDataSize,opts.nameLength);prependCode=prependCode+';\n'+bulkCode;bulkDataAdded=opts.bulkDataTables;}if(opts.vmOpcodes&&opts.vmOpcodes>0){const vmCode=injectVMWrapper(opts.vmOpcodes,opts.vmConstants,opts.nameLength);prependCode=prependCode+';\n'+vmCode;}let code=tokensToCode(tokens,prependCode,opts.formatted);if(opts.wrapInReturn){code=generateReturnWrapper(code,opts.nameLength);}if(opts.addHeader){code=generateHeader()+code;}return{code,map:renameMap,stats:{originalTokens:originalTokenCount,identifiersRenamed:Object.keys(renameMap).length,stringsEncrypted,numbersObfuscated,predicatesInserted,deadCodeInserted,propertiesObfuscated,tableKeysObfuscated,functionsFlattened,functionsProxied,garbageFunctionsAdded,bulkDataAdded,originalLength:source.length,outputLength:code.length,timeMs:Date.now()-startTime},debugLogs:opts.debug?getDebugLogs():undefined};}
export default{obfuscate,tokenize,enableDebug,getDebugLogs};
