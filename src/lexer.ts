export enum TokenType{NUMBER='NUMBER',STRING='STRING',BOOLEAN='BOOLEAN',NIL='NIL',IDENTIFIER='IDENTIFIER',AND='AND',BREAK='BREAK',DO='DO',ELSE='ELSE',ELSEIF='ELSEIF',END='END',FALSE='FALSE',FOR='FOR',FUNCTION='FUNCTION',GOTO='GOTO',IF='IF',IN='IN',LOCAL='LOCAL',NOT='NOT',OR='OR',REPEAT='REPEAT',RETURN='RETURN',THEN='THEN',TRUE='TRUE',UNTIL='UNTIL',WHILE='WHILE',CONTINUE='CONTINUE',PLUS='PLUS',MINUS='MINUS',STAR='STAR',SLASH='SLASH',DOUBLE_SLASH='DOUBLE_SLASH',PERCENT='PERCENT',CARET='CARET',HASH='HASH',EQ='EQ',NEQ='NEQ',LT='LT',GT='GT',LTE='LTE',GTE='GTE',ASSIGN='ASSIGN',LPAREN='LPAREN',RPAREN='RPAREN',LBRACE='LBRACE',RBRACE='RBRACE',LBRACKET='LBRACKET',RBRACKET='RBRACKET',SEMICOLON='SEMICOLON',COLON='COLON',DOUBLE_COLON='DOUBLE_COLON',COMMA='COMMA',DOT='DOT',DOT_DOT='DOT_DOT',DOT_DOT_DOT='DOT_DOT_DOT',EOF='EOF'}
export interface Token{type:TokenType;value:string;literal?:any;line:number;column:number}
const KEYWORDS:Record<string,TokenType>={'and':TokenType.AND,'break':TokenType.BREAK,'do':TokenType.DO,'else':TokenType.ELSE,'elseif':TokenType.ELSEIF,'end':TokenType.END,'false':TokenType.FALSE,'for':TokenType.FOR,'function':TokenType.FUNCTION,'goto':TokenType.GOTO,'if':TokenType.IF,'in':TokenType.IN,'local':TokenType.LOCAL,'nil':TokenType.NIL,'not':TokenType.NOT,'or':TokenType.OR,'repeat':TokenType.REPEAT,'return':TokenType.RETURN,'then':TokenType.THEN,'true':TokenType.TRUE,'until':TokenType.UNTIL,'while':TokenType.WHILE,'continue':TokenType.CONTINUE};
export interface DebugLog{phase:string;message:string;data?:any}
let debugLogs:DebugLog[]=[];let debugEnabled=false;
export function enableDebug(e:boolean=true):void{debugEnabled=e;debugLogs=[];}
export function getDebugLogs():DebugLog[]{return debugLogs;}
function debug(p:string,m:string,d?:any):void{if(debugEnabled)debugLogs.push({phase:p,message:m,data:d});}
class LuraphNameGen{private idx=0;private chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';next():string{const i=this.idx++;if(i<52)return this.chars[i];if(i<52+52*52){const a=Math.floor((i-52)/52);const b=(i-52)%52;return this.chars[a]+this.chars[b];}const n=i-52-52*52;return this.chars[n%52]+Math.floor(n/52).toString();}}
class LuraphNumFmt{static fmt(n:number):string{if(n<0)return'-'+this.fmt(-n);const fmts:string[]=[n.toString(),`0X${n.toString(16).toUpperCase()}`,`0x${n.toString(16)}`,`0B${n.toString(2)}`,`0b${n.toString(2)}`];if(n>255){const h=n.toString(16).toUpperCase();if(h.length>=2){const m=Math.floor(h.length/2);fmts.push(`0X${h.slice(0,m)}__${h.slice(m)}`);fmts.push(`0x${h.toLowerCase().slice(0,m)}_${h.toLowerCase().slice(m)}`);}const b=n.toString(2);if(b.length>=4){const p:string[]=[];for(let i=0;i<b.length;i+=4)p.push(b.slice(i,i+4));fmts.push(`0B${p.join('_')}`);fmts.push(`0b${p.join('__')}`);}}return fmts[Math.floor(Math.random()*fmts.length)];}static expr(n:number):string{if(Math.abs(n)<10)return this.fmt(n);const r=Math.random();if(r<0.3){const a=Math.floor(Math.random()*100)+10;return`(${this.fmt(a)}+${this.fmt(n-a)})`;}if(r<0.6){const a=n+Math.floor(Math.random()*100)+10;return`(${this.fmt(a)}-${this.fmt(a-n)})`;}if(r<0.8&&n>1){for(let f=2;f<=Math.min(10,Math.sqrt(n));f++){if(n%f===0)return`(${this.fmt(f)}*${this.fmt(n/f)})`;}}return this.fmt(n);}}
class LuraphStrEnc{static enc(s:string,k:number):string{let r='';for(let i=0;i<s.length;i++){const c=(s.charCodeAt(i)^k)&0xFF;const f=Math.random();if(f<0.25)r+=`\\u{${c.toString(16).padStart(2,'0')}}`;else if(f<0.5)r+=`\\x${c.toString(16).padStart(2,'0')}`;else if(f<0.75)r+=`\\${c.toString(8).padStart(3,'0')}`;else r+=`\\x${c.toString(16).padStart(2,'0')}`;}return r;}static rnd(len:number):string{let r='';for(let i=0;i<len;i++){const v=Math.floor(Math.random()*256);if(Math.random()<0.3)r+=`\\u{${v.toString(16).padStart(2,'0')}}`;else r+=`\\x${v.toString(16).padStart(2,'0')}`;}return r;}}
class VMStructGen{private ng=new LuraphNameGen();private genN():string{return this.ng.next();}genTableEntry():string{const n=this.genN();const fns:string[]=[`${n}=function(a,X,K,e)e=({});(K)[${LuraphNumFmt.fmt(1)}]=(tostring);K[${LuraphNumFmt.fmt(2)}]=(nil);(K)[${LuraphNumFmt.fmt(3)}]=(nil);X=(${LuraphNumFmt.fmt(12)});repeat if X==${LuraphNumFmt.fmt(12)} then(K)[${LuraphNumFmt.fmt(2)}]=a.${this.genN()};if not(not e[${LuraphNumFmt.fmt(3091)}])then X=(e[${LuraphNumFmt.fmt(3091)}]);else X=a:${this.genN()}(e,X);end;else if X~=${LuraphNumFmt.fmt(123)} then else K[${LuraphNumFmt.fmt(3)}]=a.${this.genN()};break;end;end;until false;return e,X;end`,`${n}=function(a,X,K,e,z,Y,f)local r;(f)[${LuraphNumFmt.fmt(44)}]=(nil);f[${LuraphNumFmt.fmt(45)}]=(nil);X=(nil);z=(${LuraphNumFmt.fmt(76)});while true do X,r,z=a:${this.genN()}(f,z,K,X);if r~=${LuraphNumFmt.fmt(61103)} then else break;end;end;e=(function(...)local K;K=a:${this.genN()}(...);return a.${this.genN()}(K);end);Y=X();(f[${LuraphNumFmt.fmt(39)}])[${LuraphNumFmt.fmt(13)}]=a.${this.genN()};z=${LuraphNumFmt.fmt(99)};return X,z,Y,e;end`,`${n}=function(a,a,X)X=a[${LuraphNumFmt.fmt(4387)}];return X;end`,`${n}=function(a,X,K)K=${LuraphNumFmt.fmt(94)}+((a.${this.genN()}(X[${LuraphNumFmt.fmt(8790)}]+X[${LuraphNumFmt.fmt(24554)}]-a.${this.genN()}[${LuraphNumFmt.fmt(8)}],K,X[${LuraphNumFmt.fmt(6816)}]))-X[${LuraphNumFmt.fmt(8790)}]);(X)[${LuraphNumFmt.fmt(18388)}]=K;return K;end`,`${n}=function(a,a,X,K)X=(${LuraphNumFmt.fmt(102)});while a[${LuraphNumFmt.fmt(43)}]do K=(a[${LuraphNumFmt.fmt(32)}]);end;return K,X;end`];return fns[Math.floor(Math.random()*fns.length)];}genComplexFn():string{const n=this.genN();const v1=this.genN(),v2=this.genN(),v3=this.genN();return`${n}=function(a,X,K,e,z)if not(K>${LuraphNumFmt.fmt(29)})then z=(function()local ${v1},${v2};${v1},${v2}=a:${this.genN()}(X,${v2});if ${v1}==-${LuraphNumFmt.fmt(1)} then return;end;(X)[${LuraphNumFmt.fmt(14)}]=a.${this.genN()};X[${LuraphNumFmt.fmt(16)}]=(nil);return ${v2};end);return z,${LuraphNumFmt.fmt(61103)},K;else X[${LuraphNumFmt.fmt(44)}]=(function(Y,f,r)local U=Y[${LuraphNumFmt.fmt(9)}];local V,E,T,c,M,H,u,v=Y[${LuraphNumFmt.fmt(4)}],Y[${LuraphNumFmt.fmt(5)}],Y[${LuraphNumFmt.fmt(1)}],Y[${LuraphNumFmt.fmt(11)}],Y[${LuraphNumFmt.fmt(6)}],Y[${LuraphNumFmt.fmt(10)}],Y[${LuraphNumFmt.fmt(2)}],Y[${LuraphNumFmt.fmt(3)}];r=(nil);r=(function(...)local B,x,w,C,I=${LuraphNumFmt.fmt(1)},${LuraphNumFmt.fmt(1)},(X[${LuraphNumFmt.fmt(31)}](U));local U,Q=X[${LuraphNumFmt.fmt(43)}](...);local O,S,R,o,g,D=${LuraphNumFmt.fmt(0)},${LuraphNumFmt.fmt(1)},(X[${LuraphNumFmt.fmt(8)}]());return B,x,w;end);return r;end);end;end`;}genWhileLoop():string{const v=this.genN();const cond=this.genN();const st=Math.floor(Math.random()*200)+50;return`${v}=(${LuraphNumFmt.fmt(st)});${cond}=(nil);while true do if ${v}<${LuraphNumFmt.fmt(47)} then ${cond}*=${v};break;elseif ${v}>${LuraphNumFmt.fmt(71)} then ${cond}=${LuraphNumFmt.fmt(4503599627370495)};${v}=-${LuraphNumFmt.fmt(142)}+((X[${LuraphNumFmt.fmt(39)}][${LuraphNumFmt.fmt(15)}](${v}-d<=d and d or ${v}))+d);continue;elseif not(${v}>${LuraphNumFmt.fmt(17)} and ${v}<${LuraphNumFmt.fmt(122)})then else ${cond}=-${LuraphNumFmt.fmt(707)};${v}=${LuraphNumFmt.fmt(0)};${v}=(-${LuraphNumFmt.fmt(798)}+(X[${LuraphNumFmt.fmt(39)}][${LuraphNumFmt.fmt(10)}](d+${v}+d-d,(${LuraphNumFmt.fmt(2)}))));continue;end;end`;}genOpcodeHandler():string{const cases:string[]=[];const numCases=Math.floor(Math.random()*10)+5;for(let i=0;i<numCases;i++){const op=Math.floor(Math.random()*256);const v1=this.genN(),v2=this.genN();const handlers=[`if d==${LuraphNumFmt.fmt(op)} then(w[T[B]])[w[M[B]]]=(w[u[B]]);`,`if d==${LuraphNumFmt.fmt(op)} then ${v1}=(u[B]);(w[${v1}])(X[${LuraphNumFmt.fmt(18)}](x,${v1}+${LuraphNumFmt.fmt(1)},w));x=${v1}-${LuraphNumFmt.fmt(1)};`,`if d==${LuraphNumFmt.fmt(op)} then(w)[u[B]]=(c);`,`if d==${LuraphNumFmt.fmt(op)} then(w)[T[B]]=(nil);`,`if d==${LuraphNumFmt.fmt(op)} then ${v1}=(M[B]);for t=${v2},${v1} do P=(w);${v2}=t;t=(nil);P[${v2}]=t;end;`,`if d==${LuraphNumFmt.fmt(op)} then ${v1}=(T[B]);(w)[${v1}]=w[${v1}](X[${LuraphNumFmt.fmt(18)}](x,${v1}+${LuraphNumFmt.fmt(1)},w));x=${v1};`,`if d==${LuraphNumFmt.fmt(op)} then(w)[M[B]]=w[u[B]]-w[T[B]];`,`if d==${LuraphNumFmt.fmt(op)} then(w)[M[B]]=(X[${LuraphNumFmt.fmt(28)}](w[u[B]],w[T[B]]));`];cases.push(handlers[Math.floor(Math.random()*handlers.length)]+'end');}return cases.join('else ');}genDataTable(size:number):string{const n=this.genN();const entries:string[]=[];for(let i=0;i<size;i++){const k=Math.floor(Math.random()*10000);const v=Math.floor(Math.random()*100000);entries.push(`[${LuraphNumFmt.fmt(k)}]=${LuraphNumFmt.fmt(v)}`);}return`${n}={${entries.join(',')}}`;}genStringTable(size:number):string{const n=this.genN();const entries:string[]=[];for(let i=0;i<size;i++){entries.push(`"${LuraphStrEnc.rnd(Math.floor(Math.random()*20)+10)}"`);}return`${n}={${entries.join(',')}}`;}genMainStructure(count:number):string{const entries:string[]=[];entries.push(`m=select`);entries.push(`T=unpack`);entries.push(`u=coroutine.wrap`);entries.push(`g=getfenv`);for(let i=0;i<count;i++){if(Math.random()<0.4)entries.push(this.genTableEntry());else if(Math.random()<0.6)entries.push(this.genComplexFn());else entries.push(`${this.genN()}=${LuraphNumFmt.fmt(Math.floor(Math.random()*10000))}`);}return entries.join(',');}}
export class Lexer{private src:string;private tks:Token[]=[];private st=0;private cur=0;private ln=1;private col=1;private stCol=1;constructor(s:string){this.src=s;}public tokenize():Token[]{while(!this.end()){this.st=this.cur;this.stCol=this.col;this.scan();}this.tks.push({type:TokenType.EOF,value:'',line:this.ln,column:this.col});return this.tks;}private scan():void{const c=this.adv();switch(c){case'(':this.add(TokenType.LPAREN);break;case')':this.add(TokenType.RPAREN);break;case'{':this.add(TokenType.LBRACE);break;case'}':this.add(TokenType.RBRACE);break;case']':this.add(TokenType.RBRACKET);break;case'+':this.add(TokenType.PLUS);break;case'*':this.add(TokenType.STAR);break;case'%':this.add(TokenType.PERCENT);break;case'^':this.add(TokenType.CARET);break;case'#':this.add(TokenType.HASH);break;case';':this.add(TokenType.SEMICOLON);break;case',':this.add(TokenType.COMMA);break;case'.':if(this.match('.'))this.add(this.match('.')?TokenType.DOT_DOT_DOT:TokenType.DOT_DOT);else if(this.isDig(this.pk()))this.num();else this.add(TokenType.DOT);break;case'-':if(this.match('-'))this.cmt();else this.add(TokenType.MINUS);break;case'/':this.add(this.match('/')?TokenType.DOUBLE_SLASH:TokenType.SLASH);break;case':':this.add(this.match(':')?TokenType.DOUBLE_COLON:TokenType.COLON);break;case'[':if(this.pk()==='['||this.pk()==='=')this.lstr();else this.add(TokenType.LBRACKET);break;case'=':this.add(this.match('=')?TokenType.EQ:TokenType.ASSIGN);break;case'~':if(this.match('='))this.add(TokenType.NEQ);break;case'<':this.add(this.match('=')?TokenType.LTE:TokenType.LT);break;case'>':this.add(this.match('=')?TokenType.GTE:TokenType.GT);break;case'"':case"'":this.str(c);break;case' ':case'\r':case'\t':break;case'\n':this.ln++;this.col=1;break;default:if(this.isDig(c))this.num();else if(this.isAlp(c))this.ident();break;}}private str(q:string):void{let v='';while(!this.end()&&this.pk()!==q){if(this.pk()==='\n'){this.ln++;this.col=1;}if(this.pk()==='\\'){this.adv();if(!this.end()){const e=this.adv();switch(e){case'n':v+='\n';break;case't':v+='\t';break;case'r':v+='\r';break;case'\\':v+='\\';break;case'"':v+='"';break;case"'":v+="'";break;case'0':v+='\0';break;case'x':if(this.isHex(this.pk())&&this.isHex(this.pkN())){v+=String.fromCharCode(parseInt(this.adv()+this.adv(),16));}break;default:if(this.isDig(e)){let d=e;if(this.isDig(this.pk()))d+=this.adv();if(this.isDig(this.pk()))d+=this.adv();v+=String.fromCharCode(parseInt(d,10));}else v+=e;}}}else v+=this.adv();}if(!this.end())this.adv();this.add(TokenType.STRING,v);}private lstr():void{let lv=0;while(this.pk()==='='){this.adv();lv++;}if(this.pk()!=='['){this.add(TokenType.LBRACKET);return;}this.adv();if(this.pk()==='\n'){this.adv();this.ln++;this.col=1;}let v='';const cl=']'+'='.repeat(lv)+']';while(!this.end()){if(this.pk()==='\n'){v+=this.adv();this.ln++;this.col=1;}else if(this.chkSeq(cl)){for(let i=0;i<cl.length;i++)this.adv();break;}else v+=this.adv();}this.add(TokenType.STRING,v);}private num():void{if(this.src[this.st]==='0'){const n=this.pk().toLowerCase();if(n==='x'){this.adv();while(this.isHex(this.pk())||this.pk()==='_')this.adv();this.add(TokenType.NUMBER,parseInt(this.src.substring(this.st,this.cur).replace(/_/g,''),16));return;}else if(n==='b'){this.adv();while(this.pk()==='0'||this.pk()==='1'||this.pk()==='_')this.adv();this.add(TokenType.NUMBER,parseInt(this.src.substring(this.st+2,this.cur).replace(/_/g,''),2));return;}}while(this.isDig(this.pk())||this.pk()==='_')this.adv();if(this.pk()==='.'&&this.isDig(this.pkN())){this.adv();while(this.isDig(this.pk())||this.pk()==='_')this.adv();}if(this.pk().toLowerCase()==='e'){this.adv();if(this.pk()==='+'||this.pk()==='-')this.adv();while(this.isDig(this.pk()))this.adv();}this.add(TokenType.NUMBER,parseFloat(this.src.substring(this.st,this.cur).replace(/_/g,'')));}private ident():void{while(this.isAlpNum(this.pk()))this.adv();const t=this.src.substring(this.st,this.cur);const kw=KEYWORDS[t];if(kw!==undefined){if(kw===TokenType.TRUE)this.add(TokenType.TRUE,true);else if(kw===TokenType.FALSE)this.add(TokenType.FALSE,false);else if(kw===TokenType.NIL)this.add(TokenType.NIL,null);else this.add(kw);}else this.add(TokenType.IDENTIFIER,t);}private cmt():void{if(this.pk()==='['&&(this.pkN()==='['||this.pkN()==='=')){this.adv();let lv=0;while(this.pk()==='='){this.adv();lv++;}if(this.pk()==='['){this.adv();const cl=']'+'='.repeat(lv)+']';while(!this.end()){if(this.pk()==='\n'){this.adv();this.ln++;this.col=1;}else if(this.chkSeq(cl)){for(let i=0;i<cl.length;i++)this.adv();break;}else this.adv();}}}else{while(!this.end()&&this.pk()!=='\n')this.adv();}}private end():boolean{return this.cur>=this.src.length;}private adv():string{const c=this.src[this.cur];this.cur++;this.col++;return c;}private pk():string{return this.end()?'\0':this.src[this.cur];}private pkN():string{return this.cur+1>=this.src.length?'\0':this.src[this.cur+1];}private match(e:string):boolean{if(this.end()||this.src[this.cur]!==e)return false;this.cur++;this.col++;return true;}private chkSeq(s:string):boolean{for(let i=0;i<s.length;i++){if(this.cur+i>=this.src.length||this.src[this.cur+i]!==s[i])return false;}return true;}private isDig(c:string):boolean{return c>='0'&&c<='9';}private isHex(c:string):boolean{return this.isDig(c)||(c>='a'&&c<='f')||(c>='A'&&c<='F');}private isAlp(c:string):boolean{return(c>='a'&&c<='z')||(c>='A'&&c<='Z')||c==='_';}private isAlpNum(c:string):boolean{return this.isAlp(c)||this.isDig(c);}private add(t:TokenType,l?:any):void{const tx=this.src.substring(this.st,this.cur);this.tks.push({type:t,value:tx,literal:l!==undefined?l:tx,line:this.ln,column:this.stCol});}}
export function tokenize(s:string):Token[]{return new Lexer(s).tokenize();}
const RESERVED=new Set(['print','type','tostring','tonumber','pairs','ipairs','next','select','unpack','pcall','xpcall','error','assert','setmetatable','getmetatable','rawget','rawset','rawequal','loadstring','load','dofile','require','collectgarbage','setfenv','getfenv','math','string','table','os','io','coroutine','debug','bit32','bit','utf8','package','game','workspace','script','plugin','wait','spawn','delay','tick','time','elapsedTime','warn','typeof','task','version','settings','Instance','Vector3','Vector2','CFrame','Color3','UDim','UDim2','Enum','Ray','Region3','Rect','BrickColor','TweenInfo','NumberSequence','ColorSequence','NumberRange','PhysicalProperties','Random','Axes','Faces','getgenv','getrenv','getrawmetatable','setrawmetatable','hookfunction','hookmetamethod','newcclosure','islclosure','iscclosure','checkcaller','getinfo','getupvalue','setupvalue','getconstant','setconstant','getconnections','firesignal','fireserver','fireclient','syn','Synapse','Drawing','request','http_request','HttpGet','HttpPost','readfile','writefile','appendfile','isfile','isfolder','makefolder','listfiles','setclipboard','identifyexecutor','getexecutorname','gethiddenproperty','sethiddenproperty','gethui','getinstances','getnilinstances','_G','_VERSION','_ENV','self','nil','true','false','shared']);
export interface RenameMap{[k:string]:string}
const STMT_KW=new Set([TokenType.LOCAL,TokenType.FUNCTION,TokenType.IF,TokenType.THEN,TokenType.ELSE,TokenType.ELSEIF,TokenType.END,TokenType.DO,TokenType.WHILE,TokenType.FOR,TokenType.REPEAT,TokenType.UNTIL,TokenType.RETURN,TokenType.BREAK,TokenType.GOTO]);
function isTblKey(tks:Token[],i:number):boolean{const n=tks[i+1];if(!n||n.type!==TokenType.ASSIGN)return false;let d=0;for(let j=i-1;j>=0;j--){const t=tks[j];if(t.type===TokenType.RBRACE){d++;continue;}if(t.type===TokenType.LBRACE){if(d===0)return true;d--;continue;}if(d>0)continue;if(t.type===TokenType.SEMICOLON)return false;if(STMT_KW.has(t.type))return false;}return false;}
function analyzeIds(tks:Token[]):Set<string>{const lv=new Set<string>();for(let i=0;i<tks.length;i++){const t=tks[i];if(t.type!==TokenType.IDENTIFIER)continue;if(RESERVED.has(t.value))continue;const p=tks[i-1];const p2=tks[i-2];if(p&&(p.type===TokenType.DOT||p.type===TokenType.COLON))continue;if(isTblKey(tks,i))continue;let isL=false;if(p&&p.type===TokenType.LOCAL)isL=true;if(!isL&&p&&p.type===TokenType.COMMA){for(let j=i-1;j>=0;j--){const tk=tks[j];if(tk.type===TokenType.LOCAL){isL=true;break;}if(tk.type===TokenType.ASSIGN||tk.type===TokenType.IN||STMT_KW.has(tk.type))break;}}if(!isL&&p&&p.type===TokenType.FUNCTION){if(p2&&p2.type===TokenType.LOCAL)isL=true;}if(!isL){let pd=0;for(let j=i-1;j>=0;j--){const tk=tks[j];if(tk.type===TokenType.RPAREN)pd++;else if(tk.type===TokenType.LPAREN){pd--;if(pd<0){for(let k=j-1;k>=0;k--){if(tks[k].type===TokenType.FUNCTION){isL=true;break;}if(tks[k].type!==TokenType.IDENTIFIER)break;}break;}}else if(STMT_KW.has(tk.type))break;}}if(!isL){for(let j=i-1;j>=0;j--){const tk=tks[j];if(tk.type===TokenType.FOR){isL=true;break;}if(tk.type===TokenType.DO||STMT_KW.has(tk.type))break;}}if(isL)lv.add(t.value);}return lv;}
export function createRenameMap(tks:Token[]):RenameMap{const m:RenameMap={};const g=new LuraphNameGen();const lv=analyzeIds(tks);for(const n of lv)m[n]=g.next();return m;}
export function applyRenameMap(tks:Token[],m:RenameMap):Token[]{const r:Token[]=[];for(let i=0;i<tks.length;i++){const t=tks[i];if(t.type!==TokenType.IDENTIFIER||!m[t.value]){r.push(t);continue;}const p=tks[i-1];if(p&&(p.type===TokenType.DOT||p.type===TokenType.COLON)){r.push(t);continue;}if(isTblKey(tks,i)){r.push(t);continue;}r.push({...t,value:m[t.value],literal:m[t.value]});}return r;}
function genXorKey():number{return Math.floor(Math.random()*200)+50;}
export interface StrEncResult{encrypted:Map<string,{enc:string;key:number}>;decName:string;decCode:string;xorKey:number}
export function encryptStrings(tks:Token[]):{tokens:Token[];enc:StrEncResult}{const enc=new Map<string,{enc:string;key:number}>();const ng=new LuraphNameGen();const dn=ng.next();const gk=genXorKey();const r:Token[]=[];for(let i=0;i<tks.length;i++){const t=tks[i];if(t.type===TokenType.STRING&&typeof t.literal==='string'&&t.literal.length>0){const o=t.literal;const e=LuraphStrEnc.enc(o,gk);enc.set(o,{enc:e,key:gk});r.push({type:TokenType.IDENTIFIER,value:dn,line:t.line,column:t.column});r.push({type:TokenType.LPAREN,value:'(',line:t.line,column:t.column});r.push({type:TokenType.STRING,value:`"${e}"`,literal:e,line:t.line,column:t.column});r.push({type:TokenType.COMMA,value:',',line:t.line,column:t.column});r.push({type:TokenType.NUMBER,value:LuraphNumFmt.fmt(gk),literal:gk,line:t.line,column:t.column});r.push({type:TokenType.RPAREN,value:')',line:t.line,column:t.column});}else{r.push(t);}}const dc=`local ${dn}=(function()local b=bit32 or bit;local x=b and b.bxor or function(a,c)local r,p=${LuraphNumFmt.fmt(0)},${LuraphNumFmt.fmt(1)};while a>${LuraphNumFmt.fmt(0)} or c>${LuraphNumFmt.fmt(0)} do if a%${LuraphNumFmt.fmt(2)}~=c%${LuraphNumFmt.fmt(2)} then r=r+p;end;a,c,p=math.floor(a/${LuraphNumFmt.fmt(2)}),math.floor(c/${LuraphNumFmt.fmt(2)}),p*${LuraphNumFmt.fmt(2)};end;return r;end;return function(s,k)local o="";for i=${LuraphNumFmt.fmt(1)},#s do o=o..string.char(x(s:byte(i),k));end;return o;end;end)()`;return{tokens:r,enc:{encrypted:enc,decName:dn,decCode:dc,xorKey:gk}};}
const SKIP_PROPS=new Set(['new','Create','clone','Clone','Destroy','destroy','Parent','parent','Name','name','Value','value','Text','text','Visible','visible','Enabled','enabled','Position','position','Size','size','Color','color','Transparency','CFrame','Anchored','CanCollide','Character','Humanoid','Health','WalkSpeed','JumpPower','Hit','Target','Mouse','Keyboard','InputBegan','InputEnded','Touched','Changed','ChildAdded','ChildRemoved','AncestryChanged','GetPropertyChangedSignal','Wait','Connect','Disconnect','Once','Fire','Invoke','BindToRenderStep','UnbindFromRenderStep','Heartbeat','Stepped','RenderStepped']);
export function obfuscateProps(tks:Token[],dn:string,xk:number):{tokens:Token[];count:number}{const r:Token[]=[];let c=0;for(let i=0;i<tks.length;i++){const t=tks[i];const n=tks[i+1];if(t.type===TokenType.DOT&&n?.type===TokenType.IDENTIFIER){const pn=n.value;if(pn.length<=2||SKIP_PROPS.has(pn)){r.push(t);continue;}const e=LuraphStrEnc.enc(pn,xk);r.push({type:TokenType.LBRACKET,value:'[',line:t.line,column:t.column});r.push({type:TokenType.IDENTIFIER,value:dn,line:t.line,column:t.column});r.push({type:TokenType.LPAREN,value:'(',line:t.line,column:t.column});r.push({type:TokenType.STRING,value:`"${e}"`,literal:e,line:t.line,column:t.column});r.push({type:TokenType.COMMA,value:',',line:t.line,column:t.column});r.push({type:TokenType.NUMBER,value:LuraphNumFmt.fmt(xk),literal:xk,line:t.line,column:t.column});r.push({type:TokenType.RPAREN,value:')',line:t.line,column:t.column});r.push({type:TokenType.RBRACKET,value:']',line:t.line,column:t.column});i++;c++;}else{r.push(t);}}return{tokens:r,count:c};}
export function obfuscateNums(tks:Token[]):{tokens:Token[];count:number}{const r:Token[]=[];let c=0;for(let i=0;i<tks.length;i++){const t=tks[i];if(t.type===TokenType.NUMBER&&typeof t.literal==='number'){const n=t.literal;let inFor=false;for(let j=i-1;j>=Math.max(0,i-15);j--){if(tks[j].type===TokenType.FOR){inFor=true;break;}if(tks[j].type===TokenType.DO)break;}if(inFor){r.push(t);continue;}const p=tks[i-1];if(p?.type===TokenType.LBRACKET&&n>=1&&n<=10&&Number.isInteger(n)){r.push(t);continue;}const fmt=LuraphNumFmt.expr(n);const lexer=new Lexer(fmt);const expTks=lexer.tokenize();expTks.pop();r.push(...expTks);c++;}else{r.push(t);}}return{tokens:r,count:c};}
function genHeader(v:string):string{return`-- This file was protected using Nephilim Obfuscator v${v} [https://nephilim.dev]\n\n`;}
function genVMWrapper(innerCode:string,vmEntries:number):string{const vmGen=new VMStructGen();const entries=vmGen.genMainStructure(vmEntries);return`return({${entries},\n${innerCode}})`;}
const KW_SPACE=new Set([TokenType.LOCAL,TokenType.FUNCTION,TokenType.IF,TokenType.THEN,TokenType.ELSE,TokenType.ELSEIF,TokenType.WHILE,TokenType.DO,TokenType.FOR,TokenType.IN,TokenType.RETURN,TokenType.AND,TokenType.OR,TokenType.NOT,TokenType.END,TokenType.UNTIL,TokenType.REPEAT,TokenType.BREAK,TokenType.GOTO]);
const SP_AFT=new Set([...KW_SPACE,TokenType.IDENTIFIER,TokenType.NUMBER,TokenType.STRING,TokenType.TRUE,TokenType.FALSE,TokenType.NIL,TokenType.RPAREN,TokenType.RBRACE,TokenType.RBRACKET]);
const SP_BEF=new Set([TokenType.IDENTIFIER,TokenType.NUMBER,TokenType.STRING,TokenType.TRUE,TokenType.FALSE,TokenType.NIL,TokenType.FUNCTION,TokenType.IF,TokenType.THEN,TokenType.ELSE,TokenType.END,TokenType.LOCAL,TokenType.RETURN,TokenType.AND,TokenType.OR,TokenType.NOT,TokenType.DO,TokenType.WHILE,TokenType.FOR,TokenType.IN,TokenType.UNTIL,TokenType.REPEAT,TokenType.ELSEIF,TokenType.LBRACE]);
const NO_SP_AFT=new Set([TokenType.LPAREN,TokenType.LBRACE,TokenType.LBRACKET,TokenType.DOT,TokenType.COLON,TokenType.HASH]);
const NO_SP_BEF=new Set([TokenType.RPAREN,TokenType.RBRACE,TokenType.RBRACKET,TokenType.DOT,TokenType.COLON,TokenType.COMMA,TokenType.SEMICOLON,TokenType.LPAREN,TokenType.LBRACKET]);
export function tokensToCode(tks:Token[],pre:string=''):string{let c=pre?pre:'';for(let i=0;i<tks.length;i++){const t=tks[i];const p=tks[i-1];if(t.type===TokenType.EOF)continue;if(p&&p.type!==TokenType.EOF){let ns=false;if(KW_SPACE.has(p.type)){ns=true;}else if(!NO_SP_AFT.has(p.type)&&!NO_SP_BEF.has(t.type)){if(SP_AFT.has(p.type)||SP_BEF.has(t.type)){ns=true;}}if(ns)c+=' ';}if(t.type===TokenType.STRING){if(t.value.startsWith('"')||t.value.startsWith("'")){c+=t.value;}else{const esc=(t.literal??'').replace(/\\/g,'\\\\').replace(/"/g,'\\"').replace(/\n/g,'\\n').replace(/\r/g,'\\r').replace(/\t/g,'\\t');c+='"'+esc+'"';}}else{c+=t.value;}}return c;}
export interface ObfuscateOptions{debug?:boolean;renameVariables?:boolean;encryptStrings?:boolean;obfuscateNumbers?:boolean;obfuscateProperties?:boolean;vmEntries?:number;addHeader?:boolean}
export interface ObfuscateResult{code:string;map:RenameMap;stats:{originalTokens:number;renamed:number;stringsEncrypted:number;numbersObfuscated:number;propsObfuscated:number;originalLength:number;outputLength:number;timeMs:number};debugLogs?:DebugLog[]}
export function obfuscate(source:string,options:ObfuscateOptions={}):ObfuscateResult{const st=Date.now();const opts={debug:options.debug??false,renameVariables:options.renameVariables??true,encryptStrings:options.encryptStrings??true,obfuscateNumbers:options.obfuscateNumbers??true,obfuscateProperties:options.obfuscateProperties??true,vmEntries:options.vmEntries??30,addHeader:options.addHeader??true};enableDebug(opts.debug);let tks=tokenize(source);const origTks=tks.length;let map:RenameMap={};if(opts.renameVariables){map=createRenameMap(tks);tks=applyRenameMap(tks,map);}let strEnc=0;let pre='';let decN='';let xorK=0;if(opts.encryptStrings){const er=encryptStrings(tks);tks=er.tokens;pre=er.enc.decCode;decN=er.enc.decName;xorK=er.enc.xorKey;strEnc=er.enc.encrypted.size;}let propsOb=0;if(opts.obfuscateProperties&&decN){const pr=obfuscateProps(tks,decN,xorK);tks=pr.tokens;propsOb=pr.count;}let numsOb=0;if(opts.obfuscateNumbers){const nr=obfuscateNums(tks);tks=nr.tokens;numsOb=nr.count;}let inner=tokensToCode(tks,pre);inner=`_=${inner}`;let code=genVMWrapper(inner,opts.vmEntries);if(opts.addHeader){code=genHeader('15.2.1')+code;}return{code,map,stats:{originalTokens:origTks,renamed:Object.keys(map).length,stringsEncrypted:strEnc,numbersObfuscated:numsOb,propsObfuscated:propsOb,originalLength:source.length,outputLength:code.length,timeMs:Date.now()-st},debugLogs:opts.debug?getDebugLogs():undefined};}
export default{obfuscate,tokenize,enableDebug,getDebugLogs};
